# GitHub Copilot Instructions for Tournament App

This file provides guidance to GitHub Copilot when working with code in this repository.

## Project Overview

Tournament App is a full-stack Next.js application for managing tournaments, events, and users for the Helsingin Miekkailijat (Helsinki Fencers) organization. It uses PostgreSQL with Kysely ORM, React 19, TypeScript, and supports 4 languages (Finnish, English, Swedish, Estonian).

## Tech Stack

- **Frontend**: Next.js 16 with App Router, React 19, TypeScript, Tailwind CSS
- **Backend**: Next.js API routes with PostgreSQL + Kysely ORM
- **Database**: PostgreSQL with Kysely ORM and TypeScript-based migrations
- **Runtime**: Node.js 24+ (migrations use tsx for TypeScript execution)
- **QR Code Generation**: qrcode library for match management integration
- **Internationalization**: next-intl with URL-based routing (`/[locale]/...`)
- **Authentication**: JWT tokens with bcrypt password hashing
- **Testing**: Vitest with jsdom environment and @testing-library/react

## Common Commands

### Development & Testing
```bash
npm run dev          # Start development server
npm run test         # Run tests once
npm run test:watch   # Run tests in watch mode
npm run lint         # Run ESLint (Next.js 16+: uses 'eslint' directly, not 'next lint')
npm run lint:fix     # Run ESLint with auto-fix
npm run build        # Build for production
npm run prod         # Run tests + build + start production server
npm run start        # Start production server
```

### Database Setup (Docker)
```bash
docker-compose up -d  # Start PostgreSQL (port 5434) and Adminer (port 5433)
```

### Database Migrations
```bash
npm run migrate:create <name>  # Create new migration file (auto-numbered)
npm run migrate                # Run all pending migrations (local with .env file)
npm run migrate:down           # Roll back the last applied migration
npm run postbuild              # Run migrations (used by Vercel after build)
npm run db:codegen             # Regenerate TypeScript types from schema
```

## Key Directory Structure

- `/src/app/[locale]/`: Internationalized pages (en, fi, se, ee)
- `/src/app/api/`: REST API endpoints for players, tournaments, matches, QR match integration
- `/src/components/`: React components organized by feature (Leaderboards, Results, Tournaments)
- `/src/database/`: Database operation layer with individual service files
- `/src/context/`: React Context for global state (TournamentContext, UserContext)
- `/src/types/`: TypeScript definitions including auto-generated Kysely types and custom helper types
- `/src/languages/`: Translation files for 4 supported languages
- `/migrations/`: Database migration files (TypeScript, auto-numbered)
- `/scripts/`: Utility scripts including migration file generator

## Development Guidelines

### Code Style & Patterns

1. **TypeScript Strict Mode**: Always use strict TypeScript. The project has strict mode enabled.

2. **Component Organization**:
   - Use feature-based component structure
   - Separate display components from business logic
   - Use React Context for global state management

3. **State Management**:
   - React Context pattern with custom hooks for type safety
   - Global tournament and user state managed through context providers
   - Database operations abstracted into individual service files

4. **Naming Conventions**:
   - Use PascalCase for React components
   - Use camelCase for functions and variables
   - Use UPPER_CASE for constants

### Internationalization (Critical!)

**IMPORTANT**: Finnish locale (`fi.json`) is the source of truth for TypeScript types.

- All routes are prefixed with locale: `/[locale]/page`
- Middleware handles language switching and routing
- Finnish as default locale, comprehensive translation coverage
- **TypeScript types for `useTranslations()` are generated from `/src/languages/fi.json` via `global.d.ts`**
- **When adding new translation keys to ANY language file, ALWAYS add them to `fi.json` first**
- **Missing keys in `fi.json` will cause TypeScript errors even if they exist in other language files**
- Example: `t("somekey")` requires `"somekey"` to exist in `fi.json` for TypeScript to accept it

### Database Operations

1. **ORM Usage**:
   - Kysely ORM provides type-safe SQL queries
   - Auto-generated types from database schema in `/src/types/Kysely.ts` (regenerated by `npm run db:codegen`)
   - Custom helper types in `/src/types/MatchTypes.ts` (safe from codegen, won't be overwritten)
   - Environment-specific connection handling for development/production

2. **Database Migrations**:
   - **Migration System**: Kysely's built-in `Migrator` with TypeScript migrations
   - **Runtime**: Uses `tsx` for TypeScript execution with path alias support
   - **Migration Files**: Stored in `/migrations/` directory, auto-numbered (001_, 002_, etc.)
   
   **Workflow**:
   1. Create migration: `npm run migrate:create add_new_column`
   2. Edit generated file in `/migrations/` to implement `up()` and `down()` functions
   3. Run migrations: `npm run migrate`
   4. Update types: `npm run db:codegen`

   **Best Practices**:
   - Always implement both `up()` and `down()` for reversibility
   - One schema change per migration file
   - Test on development data before production
   - Regenerate types after applying migrations
   - Never edit applied migrations - create new ones instead

3. **Database Schema**:
   - Core tables: `users`, `tournaments`, `players`, `tournament_players`, `matches`
   - Supports both bracket and round-robin tournament formats
   - Detailed match tracking with hit counts
   - Role-based access control (admin/user)

### Testing

- Vitest with jsdom environment
- @testing-library/react for component testing
- Tests must pass before production builds
- Current coverage is limited - expand testing for new features
- Run `npm run test` before committing changes

## QR Code Match Integration

The application supports QR code generation for match management, allowing third-party apps to scan codes and submit match results externally.

### Key Components
- **QRMatchCode**: React component for generating and displaying QR codes
- **QRMatchModal**: Modal interface for creating QR matches
- **API Endpoints**: `/api/qr-match/generate` (create), `/api/qr-match/submit` (results)

### QR Code Data Structure
```typescript
interface QRMatchData {
  matchId: string;           // Unique identifier
  player1: string;           // First player name
  player2: string;           // Second player name
  tournamentId: number;      // Tournament reference
  round: number;             // Current round
  submitUrl: string;         // API endpoint for results
}
```

### CORS Configuration
The QR match submission endpoint supports cross-origin requests:
- **Development**: Allows all domains (`*`) for testing
- **Production**: Uses `CORS_ALLOWED_ORIGIN` environment variable (single domain only)
- **Implementation**: `src/app/api/qr-match/submit/route.ts` includes `getCorsHeaders()` function and OPTIONS handler
- **Limitations**: Only single origin supported; wildcard patterns not supported due to CORS spec

## Environment Setup

### Required Environment Variables
- `POSTGRES_URL`: Database connection string
- `JWT_SECRET`: JWT signing secret for authentication
- `CORS_ALLOWED_ORIGIN`: Allowed origin for QR match submissions (production only)

### Docker Development
- PostgreSQL runs on port 5434 (not default 5432)
- Adminer database management on port 5433
- Requires `hm_network` Docker network

### Local Development Setup
1. Create `.env` file with required variables
2. Start Docker containers: `docker-compose up -d`
3. Run migrations: `npm run migrate`
4. Start development server: `npm run dev`
5. Access app at http://localhost:3000

## Build & Deployment

### Build Process
- Tests run automatically before builds (`npm run build`)
- TypeScript compilation with strict mode
- Tailwind CSS processing with autoprefixer
- Production builds include internationalization optimization
- **Migrations run automatically after build** via `postbuild` script (Vercel deployment)

### Vercel Deployment
- Environment variables must be set in Vercel dashboard
- Migrations run automatically after successful build via `postbuild` hook
- No `.env` file needed - uses Vercel environment variables
- Deployment process: Tests → Build → Migrations → Start

## Security Considerations

1. **Authentication**: JWT tokens with bcrypt password hashing
2. **CORS**: Configured per environment for QR match submissions
3. **SQL Injection**: Kysely ORM provides parameterized queries
4. **Secrets**: Never commit secrets to the repository
5. **Environment Variables**: Use `.env` for local, Vercel dashboard for production

## Common Pitfalls to Avoid

1. **Translation Keys**: Always add new keys to `fi.json` first to avoid TypeScript errors
2. **Migration Editing**: Never edit applied migrations - create new ones instead
3. **Database Types**: Run `npm run db:codegen` after schema changes
4. **Port Conflicts**: PostgreSQL uses port 5434, not the default 5432
5. **Custom Types**: Put custom helper types in files that won't be overwritten by codegen
6. **CORS Configuration**: Remember single origin limitation in production

## Getting Help

- Check CLAUDE.md for additional detailed information
- Review README.md for setup instructions
- Examine existing code patterns for consistency
- Run tests to validate changes: `npm run test`
- Use linter to catch common issues: `npm run lint`
- Auto-fix linting issues when possible: `npm run lint:fix`

## Credits

Originally forked from https://github.com/Miconen/tournament-app, project co-authored by:
- [Mico Rintala](https://github.com/Miconen)
- [Niko Söder](https://github.com/NikoSoder)
- [Anton Kiiski](https://github.com/Kiiskii)
- [Kasper Keske](https://github.com/Kaztu)
